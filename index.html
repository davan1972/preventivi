
        // Mappa opzioni per modello
        const opzioniPerModello = {
            'Facile Sprint 1100': [
                { id: 'opt_estensione_guida', label: 'Estensione guida di 2.35 mt', categoria: 'guida' },
                { id: 'opt_guida_tagliata', label: 'Guida tagliata a misura', categoria: 'guida' },
                { id: 'opt_guida_ribaltabile', label: 'Guida ribaltabile manuale', categoria: 'guida' },
                { id: 'opt_tappeti', label: 'Tappeti', categoria: 'guida' },
                { id: 'opt_guida_scorrevole_47', label: 'Guida scorrevole 4.7 m', categoria: 'guida' },
                { id: 'opt_guida_scorrevole_705', label: 'Guida scorrevole 7.05 m', categoria: 'guida' },
                { id: 'opt_zero_intrusion_47', label: 'Kit zero intrusion 4.7 m', categoria: 'guida' },
                { id: 'opt_zero_intrusion_705', label: 'Kit zero intrusion 7.05 m', categoria: 'guida' },
                { id: 'opt_rotazione_auto', label: 'Rotazione seggiolino automatica', categoria: 'motorizzate' },
                { id: 'opt_pedana_motor', label: 'Poggiapiedi motorizzato', categoria: 'motorizzate' },
                { id: 'opt_motor_completo', label: 'Motorizzato completo (sedile e pedana)', categoria: 'motorizzate' },
                { id: 'opt_one_touch', label: 'One Touch Alert (SIM non inclusa)', categoria: 'motorizzate' }
            ],
            'Facile Elegance 1000': [
                { id: 'opt_estensione_guida', label: 'Estensione guida di 2.35 mt', categoria: 'guida' },
                { id: 'opt_guida_tagliata', label: 'Guida tagliata a misura', categoria: 'guida' },
                { id: 'opt_guida_ribaltabile', label: 'Guida ribaltabile manuale', categoria: 'guida' },
                { id: 'opt_tappeti', label: 'Tappeti', categoria: 'guida' },
                { id: 'opt_guida_ribaltabile_motor', label: 'Guida ribaltabile motorizzata', categoria: 'guida' },
                { id: 'opt_versione_esterni', label: 'Versione per esterni', categoria: 'guida' },
                { id: 'opt_sedile_perch', label: 'Sedile Smart Perch', categoria: 'seduta' },
                { id: 'opt_distanziale_singolo', label: 'Distanziale per bracciolo singolo (+56mm)', categoria: 'seduta' },
                { id: 'opt_distanziale_doppio', label: 'Distanziale entrambi i braccioli (+102mm)', categoria: 'seduta' },
                { id: 'opt_cintura_velcro', label: 'Cintura in Velcro XXL', categoria: 'seduta' },
                { id: 'opt_body_harness', label: 'Body harness', categoria: 'seduta' },
                { id: 'opt_heavy_duty_xl', label: 'Heavy Duty XL', categoria: 'seduta' },
                { id: 'opt_heavy_duty_xxl', label: 'Extra Heavy Duty XXL', categoria: 'seduta' },
                { id: 'opt_rotazione_auto', label: 'Rotazione seggiolino automatica', categoria: 'motorizzate' },
                { id: 'opt_rotazione_2dir', label: 'Rotazione seggiolino automatica 2-direzioni', categoria: 'motorizzate' },
                { id: 'opt_pedana_motor', label: 'Poggiapiedi motorizzato', categoria: 'motorizzate' },
                { id: 'opt_motor_completo', label: 'Motorizzato completo (sedile e pedana)', categoria: 'motorizzate' },
                { id: 'opt_motor_completo_2dir', label: 'Motorizzato completo 2-direzioni', categoria: 'motorizzate' },
                { id: 'opt_one_touch', label: 'One Touch Alert (SIM non inclusa)', categoria: 'motorizzate' },
                { id: 'opt_smontaggio', label: 'Smontaggio e smaltimento impianto preesistente', categoria: 'servizi' }
            ],
            'Facile Superior H4000': [
                { id: 'metri_guida', label: 'Metri guida', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 7.5' },
                { id: 'opt_sedile_perch', label: 'Sedile Smart Perch', categoria: 'seduta' },
                { id: 'opt_sedile_esterni', label: 'Sedile SMART (versione esterna)', categoria: 'seduta' },
                { id: 'opt_sedile_style', label: 'Sedile Style', categoria: 'seduta' },
                { id: 'opt_bracciolo_corto', label: 'Bracciolo corto', categoria: 'seduta' },
                { id: 'opt_distanziale_singolo', label: 'Distanziale per bracciolo singolo (+56mm)', categoria: 'seduta' },
                { id: 'opt_distanziale_doppio', label: 'Distanziale entrambi i braccioli (+102mm)', categoria: 'seduta' },
                { id: 'opt_cintura_velcro', label: 'Cintura in Velcro XXL', categoria: 'seduta' },
                { id: 'opt_body_harness', label: 'Body harness', categoria: 'seduta' },
                { id: 'curve_90_qty', label: 'Numero curve aggiuntive a 90Â°', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'punti_ricarica_qty', label: 'Numero punti di ricarica aggiuntivi', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'metri_esterni', label: 'Metri guida per esterni (supplemento)', categoria: 'input', tipo: 'number', step: '0.1', placeholder: '0' },
                { id: 'fermate_intermedie_qty', label: 'Numero fermate intermedie', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'opt_overrun', label: 'Overrun', categoria: 'guida' },
                { id: 'opt_dropnose', label: 'Dropnose', categoria: 'guida' },
                { id: 'opt_guida_ribaltabile_motor', label: 'Guida ribaltabile motorizzata', categoria: 'guida' },
                { id: 'opt_heavy_duty_160', label: 'Heavy duty kit 160 kg', categoria: 'guida' },
                { id: 'opt_tappeti', label: 'Tappeti', categoria: 'guida' },
                { id: 'opt_colore_speciale', label: 'Colore speciale guida (solo numeri RAL)', categoria: 'guida' },
                { id: 'opt_versione_esterni', label: 'Versione per esterni', categoria: 'guida' },
                { id: 'opt_piastre_muro', label: 'Piastre per attacco a muro', categoria: 'guida' },
                { id: 'opt_conversion_kit', label: 'Conversion Kit', categoria: 'guida' },
                { id: 'opt_rotazione_auto', label: 'Rotazione seggiolino automatica', categoria: 'motorizzate' },
                { id: 'opt_pedana_motor', label: 'Poggiapiedi motorizzato', categoria: 'motorizzate' },
                { id: 'opt_motor_completo', label: 'Motorizzato completo (sedile e pedana)', categoria: 'motorizzate' },
                { id: 'radiocomandi_qty', label: 'Numero radiocomandi aggiuntivi', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'opt_one_touch', label: 'One Touch Alert (SIM non inclusa)', categoria: 'motorizzate' }
            ],
            'Facile Graziosa Freecurve': [
                { id: 'metri_guida', label: 'Metri guida', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 7.5' },
                { id: 'curve_90_qty', label: 'Numero curve aggiuntive a 90Â°', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'punti_ricarica_qty', label: 'Numero punti di ricarica aggiuntivi', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'attacchi_muro_qty', label: 'Numero attacchi a muro aggiuntivi', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'radiocomandi_qty', label: 'Numero radiocomandi aggiuntivi', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'opt_elegance_seat', label: 'Elegance seat', categoria: 'seduta' },
                { id: 'opt_alliance_seat', label: 'Alliance seat', categoria: 'seduta' },
                { id: 'opt_active_seat', label: 'Active seat (solo Elegance/Alliance)', categoria: 'seduta' },
                { id: 'opt_body_harness_4p', label: 'Body harness 4-punti', categoria: 'seduta' },
                { id: 'opt_guida_ribaltabile_motor', label: 'Guida ribaltabile motorizzata', categoria: 'guida' },
                { id: 'opt_colore_speciale', label: 'Colore speciale guida (solo numeri RAL)', categoria: 'guida' },
                { id: 'opt_solo_guida', label: 'Solo guida/supplemento rework', categoria: 'guida' },
                { id: 'opt_rotazione_auto', label: 'Rotazione seggiolino automatica', categoria: 'motorizzate' },
                { id: 'opt_rotazione_2dir', label: 'Rotazione automatica sedile 2-direzioni', categoria: 'motorizzate' },
                { id: 'opt_pedana_illuminato', label: 'Poggiapiedi illuminato e motorizzato', categoria: 'motorizzate' },
                { id: 'opt_batteria_extra', label: 'Batteria Extra Power 12 Ah (oltre 15 metri)', categoria: 'motorizzate' },
                { id: 'opt_batteria_ultra', label: 'Batteria Ultra Power 20 Ah litio (oltre 20 metri)', categoria: 'motorizzate' },
                { id: 'opt_kit_ripetitore', label: 'Kit Ripetitore', categoria: 'motorizzate' }
            ],
            'Infinity Curvilineo Bespoke': [
                { id: 'metri_guida', label: 'Metri guida aggiuntivi (oltre 5m)', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 3' },
                { id: 'metri_guida_hd', label: 'Metri guida HD aggiuntivi (oltre 5m)', categoria: 'input', tipo: 'number', step: '0.1', placeholder: '0' },
                { id: 'curve_90_qty', label: 'Numero curve 90Â° aggiuntive', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'curve_180_qty', label: 'Numero curve 180Â° aggiuntive', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'curve_speciali_qty', label: 'Numero curve speciali', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'fermate_intermedie_qty', label: 'Numero fermate intermedie', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'punti_ricarica_qty', label: 'Numero punti di ricarica', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'telecomandi_qty', label: 'Numero telecomandi aggiuntivi', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'opt_motor_hd', label: 'Motore HD (girevole manuale)', categoria: 'seduta' },
                { id: 'opt_seduta_regolabile', label: 'Seduta regolabile (estensione 100mm)', categoria: 'seduta' },
                { id: 'opt_sedile_motor', label: 'Sedile girevole motorizzato', categoria: 'motorizzate' },
                { id: 'opt_dual_control', label: 'Dual-Control Kit', categoria: 'motorizzate' },
                { id: 'opt_partenza_drop', label: 'Partenza Drop', categoria: 'guida' },
                { id: 'opt_arrivo_orizzontale', label: 'Arrivo orizzontale', categoria: 'guida' },
                { id: 'opt_fissaggio_muro', label: 'Fissaggio a muro', categoria: 'guida' },
                { id: 'opt_coprigambe', label: 'Coprigambe', categoria: 'seduta' },
                { id: 'opt_colore_nero', label: 'Colore binario nero', categoria: 'guida' },
                { id: 'opt_colore_marrone', label: 'Colore binario marrone', categoria: 'guida' }
            ],
            'Facile Step SRC': [
                { id: 'alzate', label: 'Numero alzate', categoria: 'input', tipo: 'number', placeholder: 'Es: 13' },
                { id: 'metri_guida_extra', label: 'Metri guida aggiuntivi', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 2.5' },
                { id: 'colonnini_qty', label: 'Numero colonnini chiamate ai piani', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'fermate_intermedie_qty', label: 'Numero fermate intermedie', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'opt_ped_esterni', label: 'Versione per esterni (guida zincata)', categoria: 'opzioni' },
                { id: 'opt_ped_acustico', label: 'Comando acustico luminoso a bordo', categoria: 'opzioni' }
            ],
            'Facile Step SSC': [
                { id: 'alzate', label: 'Numero alzate', categoria: 'input', tipo: 'number', placeholder: 'Es: 13' },
                { id: 'metri_guida_extra', label: 'Metri guida aggiuntivi', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 2.5' },
                { id: 'curve_90_qty', label: 'Numero curve 90Â°', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'curve_180_qty', label: 'Numero curve 180Â°', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'colonnini_qty', label: 'Numero colonnini chiamate ai piani', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'fermate_intermedie_qty', label: 'Numero fermate intermedie', categoria: 'input', tipo: 'number', placeholder: '0' },
                { id: 'opt_ped_esterni', label: 'Versione per esterni (guida zincata)', categoria: 'opzioni' },
                { id: 'opt_ped_acustico', label: 'Comando acustico luminoso a bordo', categoria: 'opzioni' },
                { id: 'opt_curve_zincate', label: 'Curve zincate (supplemento)', categoria: 'opzioni' }
            ],
            'Facile Step X3': [
                { id: 'alzate', label: 'Numero alzate', categoria: 'input', tipo: 'number', placeholder: 'Es: 13' },
                { id: 'metri_guida_extra', label: 'Metri guida aggiuntivi', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 2.5' },
                { id: 'opt_piattaforma_640', label: 'Piattaforma 640x680', categoria: 'dimensioni' },
                { id: 'opt_piattaforma_800', label: 'Piattaforma 800x800', categoria: 'dimensioni' },
                { id: 'opt_piattaforma_1050', label: 'Piattaforma 800x1050', categoria: 'dimensioni' },
                { id: 'opt_ped_esterni', label: 'Versione per esterni (guida zincata)', categoria: 'opzioni' }
            ],
            'Facile Step ARTIRA': [
                { id: 'alzate', label: 'Numero alzate', categoria: 'input', tipo: 'number', placeholder: 'Es: 13' },
                { id: 'metri_guida_extra', label: 'Metri guida aggiuntivi', categoria: 'input', tipo: 'number', step: '0.1', placeholder: 'Es: 2.5' }
            ]
        };

        // Genera HTML opzioni dinamiche
        function generaOpzioni(modello) {
            const container = document.getElementById('opzioniContainer');
            container.innerHTML = '';

            const opzioni = opzioniPerModello[modello];
            if (!opzioni) return;

            const categorie = {};
            opzioni.forEach(opt => {
                if (!categorie[opt.categoria]) categorie[opt.categoria] = [];
                categorie[opt.categoria].push(opt);
            });

            const titoliCategorie = {
                'input': 'Misure e QuantitÃ ',
                'guida': 'Opzioni Guida',
                'seduta': 'Opzioni Seduta',
                'motorizzate': 'Opzioni Motorizzate',
                'servizi': 'Servizi',
                'opzioni': 'Opzioni Aggiuntive',
                'dimensioni': 'Dimensioni Piattaforma'
            };

            Object.keys(categorie).forEach(cat => {
                const divCategoria = document.createElement('div');
                divCategoria.className = 'option-category';
                
                const titolo = document.createElement('h3');
                titolo.className = 'category-title';
                titolo.textContent = titoliCategorie[cat] || cat;
                divCategoria.appendChild(titolo);

                if (cat === 'input') {
                    categorie[cat].forEach(opt => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'input-wrapper';
                        wrapper.innerHTML = `
                            <label>${opt.label}</label>
                            <input type="${opt.tipo}" name="${opt.id}" step="${opt.step || 1}" min="0" placeholder="${opt.placeholder}" class="calc-trigger">
                        `;
                        divCategoria.appendChild(wrapper);
                    });
                } else {
                    const checkboxGroup = document.createElement('div');
                    checkboxGroup.className = 'checkbox-group';
                    
                    categorie[cat].forEach(opt => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'checkbox-option';
                        checkboxDiv.innerHTML = `
                            <input type="checkbox" id="${opt.id}" name="${opt.id}" class="calc-trigger">
                            <label for="${opt.id}">
                                <span class="checkbox-icon"></span>
                                ${opt.label}
                            </label>
                        `;
                        checkboxGroup.appendChild(checkboxDiv);
                    });
                    
                    divCategoria.appendChild(checkboxGroup);
                }

                container.appendChild(divCategoria);
            });

            setTimeout(() => {
                document.querySelectorAll('.calc-trigger').forEach(el => {
                    el.addEventListener('change', calcolaTotale);
                    el.addEventListener('input', calcolaTotale);
                });
                calcolaTotale();
            }, 100);
        }

        // Gestione cambio tipo prodotto
        document.querySelectorAll('input[name="tipo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const modelliPoltroncina = document.getElementById('modelliPoltroncina');
                const modelliPedana = document.getElementById('modelliPedana');

                document.querySelectorAll('input[name="modello"]').forEach(m => m.checked = false);
                document.getElementById('opzioniContainer').innerHTML = '';

                if (this.value === 'poltroncina') {
                    modelliPoltroncina.classList.remove('hidden');
                    modelliPedana.classList.add('hidden');
                } else {
                    modelliPoltroncina.classList.add('hidden');
                    modelliPedana.classList.remove('hidden');
                }
            });
        });

        // Gestione cambio modello
        document.querySelectorAll('input[name="modello"]').forEach(radio => {
            radio.addEventListener('change', function() {
                generaOpzioni(this.value);
            });
        });

        // Listener campo sconto
        document.getElementById('sconto').addEventListener('input', calcolaTotale);

        // Gestione invio form
        document.getElementById('preventivoForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            const numeroPreventivo = `MS-${new Date().getFullYear()}-${Date.now().toString().slice(-6)}`;
            const dataOggi = new Date().toLocaleDateString('it-IT');

            const prezzoListinoText = document.getElementById('prezzoListino').textContent;
            const prezzoFinaleIvaText = document.getElementById('prezzoFinaleIva').textContent;
            
            const totaleNetto = parseFloat(prezzoListinoText.replace('â‚¬ ', '').replace(/\./g, '').replace(',', '.')) || 0;
            const totaleIvato = parseFloat(prezzoFinaleIvaText.match(/â‚¬ ([\d.,]+)/)[1].replace(/\./g, '').replace(',', '.')) || 0;
            const sconto = parseFloat(data.sconto) || 0;

            const risultato = document.getElementById('risultato');
            risultato.style.display = 'block';
            risultato.innerHTML = `
                <h2>âœ“ Preventivo Generato</h2>
                <p style="margin: 20px 0;">Il preventivo Ã¨ stato creato con successo.</p>
                <p style="font-size: 0.95rem; opacity: 0.9;">
                    <strong>Preventivo n. ${numeroPreventivo}</strong><br>
                    Data: ${dataOggi}<br>
                    Totale IVA inclusa: â‚¬ ${totaleIvato.toFixed(2)}
                </p>
                <button onclick="stampaPDF()" 
                        style="display: inline-block; 
                               background: white; 
                               color: #1e40af; 
                               padding: 14px 32px; 
                               border: 2px solid white;
                               border-radius: 12px; 
                               font-weight: 600;
                               margin-top: 20px;
                               cursor: pointer;
                               font-family: 'Outfit', sans-serif;
                               font-size: 1rem;">
                    ðŸ“„ Scarica/Stampa PDF
                </button>
            `;

            risultato.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        // Funzione genera HTML preventivo
        function generaHTMLPreventivo(numero, data, formData, totaleNetto, totaleIvato, sconto) {
            const totaleDopoSconto = totaleNetto * (1 - sconto / 100);
            const iva = totaleDopoSconto * 0.04;

            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; padding: 40px; }
        .header { text-align: center; margin-bottom: 40px; border-bottom: 4px solid #1e40af; padding-bottom: 20px; }
        .header h1 { color: #1e40af; margin: 0; }
        .section { margin: 30px 0; padding: 20px; background: #f0f9ff; border-radius: 8px; }
        .section h2 { color: #1e40af; border-bottom: 2px solid #0ea5e9; padding-bottom: 8px; }
        .price-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #bae6fd; }
        .price-row.total { font-size: 1.3rem; font-weight: bold; color: #1e40af; border-top: 3px solid #0ea5e9; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PREVENTIVO MONTASCALE</h1>
        <p><strong>NÂ° ${numero}</strong> - ${data}</p>
    </div>
    <div class="section">
        <h2>Dati Cliente</h2>
        <p><strong>Nome:</strong> ${formData.cliente_nome}</p>
        ${formData.cliente_email ? `<p><strong>Email:</strong> ${formData.cliente_email}</p>` : ''}
        ${formData.cliente_telefono ? `<p><strong>Telefono:</strong> ${formData.cliente_telefono}</p>` : ''}
        ${formData.indirizzo ? `<p><strong>Indirizzo:</strong> ${formData.indirizzo}</p>` : ''}
    </div>
    <div class="section">
        <h2>Prodotto</h2>
        <p><strong>Tipo:</strong> ${formData.tipo === 'poltroncina' ? 'Montascale a Poltroncina' : 'Montascale a Pedana'}</p>
        <p><strong>Modello:</strong> ${formData.modello}</p>
    </div>
    <div class="section">
        <h2>Riepilogo Economico</h2>
        <div class="price-row"><span>Prezzo di Listino:</span><span>â‚¬ ${totaleNetto.toFixed(2)}</span></div>
        ${sconto > 0 ? `<div class="price-row"><span>Sconto (${sconto}%):</span><span>- â‚¬ ${(totaleNetto * sconto / 100).toFixed(2)}</span></div>` : ''}
        <div class="price-row"><span>IVA (4%):</span><span>â‚¬ ${iva.toFixed(2)}</span></div>
        <div class="price-row total"><span>TOTALE:</span><span>â‚¬ ${totaleIvato.toFixed(2)}</span></div>
    </div>
    ${formData.note ? `<div class="section"><h2>Note</h2><p>${formData.note}</p></div>` : ''}
</body>
</html>`;
        }

        // Funzione stampa PDF
        function stampaPDF() {
            const formData = new FormData(document.getElementById('preventivoForm'));
            const data = Object.fromEntries(formData.entries());
            const numeroPreventivo = document.querySelector('#risultato strong').textContent.replace('Preventivo n. ', '');
            const dataOggi = new Date().toLocaleDateString('it-IT');
            
            const prezzoListinoText = document.getElementById('prezzoListino').textContent;
            const prezzoFinaleIvaText = document.getElementById('prezzoFinaleIva').textContent;
            const totaleNetto = parseFloat(prezzoListinoText.replace('â‚¬ ', '').replace(/\./g, '').replace(',', '.')) || 0;
            const totaleIvato = parseFloat(prezzoFinaleIvaText.match(/â‚¬ ([\d.,]+)/)[1].replace(/\./g, '').replace(',', '.')) || 0;
            const sconto = parseFloat(data.sconto) || 0;

            const htmlContent = generaHTMLPreventivo(numeroPreventivo, dataOggi, data, totaleNetto, totaleIvato, sconto);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
